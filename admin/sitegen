#!/usr/bin/env bash

# standard invocation of sitegen.py

### <CONFIGURATION> ###
VENV_VERSION="15.1.0"
URL="https://pypi.python.org/packages/d4/0c/9840c08189e030873387a73b90ada981885010dd9aea134d6de30cd24cb8/virtualenv-$VENV_VERSION.tar.gz"
### </CONFIGURATION> ###


set -e

err() {
  echo "### $1"
  exit 1
}

ROOT="$(hg root)"
cd "$ROOT"

echo "Checking presence of Isabelle ..."

if [ ! -x "$ISABELLE_TOOL" ]; then
  echo "Isabelle not present at '$ISABELLE_TOOL', trying to use '$ISABELLE_RELEASES'"
  if [ ! -d "$ISABELLE_RELEASES" ]; then
    err "No Isabelle releases found"
  else
    if [ -z "$ISABELLE_VERSION" ]; then
      echo "Trying to detect Isabelle version ..."
      if [[ "$(basename "$(hg config paths.default)")" =~ ^afp-(.+)$ ]]; then
        ISABELLE_VERSION="${BASH_REMATCH[1]}"
        echo "Detected '$ISABELLE_VERSION'"
      else
        err "Unable to detect Isabelle version"
      fi
    fi

    ISABELLE_VERSION="Isabelle$ISABELLE_VERSION"

    case "$(uname -s)" in
      Darwin)
        ISABELLE_TOOL="$ISABELLE_RELEASES/$ISABELLE_VERSION.app/Isabelle/bin/isabelle"
        ;;
      *)
        ISABELLE_TOOL="$ISABELLE_RELEASES/$ISABELLE_VERSION/bin/isabelle"
        ;;
    esac

    if [ ! -x "$ISABELLE_TOOL" ]; then
      err "Isabelle version is not present in '$ISABELLE_RELEASES'"
    else
      echo "Using '$ISABELLE_TOOL'"
    fi
  fi
fi

echo "Obtaining dependency information ..."

DEPENDENCIES_FILE="$(mktemp /tmp/afp.XXX)"
"$ISABELLE_TOOL" afp_dependencies > "$DEPENDENCIES_FILE" || err "Could not obtain dependency information"

echo "Checking presence of Python ..."

USE_PYTHON_3=false
if [ "$1" = "--python3" ]; then
  USE_PYTHON_3=true
  shift
fi

case "$(uname -s)" in
  Darwin)
    echo "Running on macOS, using system python"
    PYTHON="/usr/bin/python"
    ;;
  *)
    if [ "$USE_PYTHON_3" = false ]; then
      echo "Running on Linux, trying to find Python 2.x"
      PYTHON="$(which python2 2> /dev/null)"
      if [ -z "$PYTHON" ]; then
        PYTHON="$(which python 2> /dev/null)"
      fi
    else
      echo "Running on Linux, trying to find Python 3.x"
      PYTHON="$(which python3 2> /dev/null)"
    fi
    ;;
esac

if [ ! -f "$PYTHON" ]; then
  err "No suitable Python found"
else
  echo "Found Python at '$PYTHON'"
fi

echo "Checking presence of bootstrapping ..."

BOOTSTRAP_DIR="$ROOT/admin/py-bootstrap"
export PYTHONPATH="$BOOTSTRAP_DIR/lib/python"

if [ ! -d "$BOOTSTRAP_DIR" ]; then
  echo "Bootstrapping ..."
  mkdir -p "$BOOTSTRAP_DIR/bin"
  mkdir -p "$BOOTSTRAP_DIR/lib/python"
  (
    cd "$BOOTSTRAP_DIR"
    curl -sS "$URL" | tar xzf -
    cd "virtualenv-$VENV_VERSION"
    "$PYTHON" setup.py install --home "$BOOTSTRAP_DIR"
  )
fi

echo "Bootstrapped."

VENV_DIR="$ROOT/admin/venv"

if [ ! -d "$VENV_DIR" ]; then
  echo "Creating venv ..."
  "$PYTHON" "$BOOTSTRAP_DIR/bin/virtualenv" "$VENV_DIR"
fi

echo "Activating venv ..."
source "$VENV_DIR/bin/activate"

PYTHON="$VENV_DIR/bin/python"
PIP="$VENV_DIR/bin/pip"

echo "Installing dependencies ..."
"$PIP" install -q -r "$ROOT/admin/sitegen-req.txt"

echo "Running sitegen ..."
"$PYTHON" admin/sitegen-lib/sitegen.py --dest=web \
                                       --templates=admin/sitegen-lib/templates \
                                       --deps="$DEPENDENCIES_FILE" \
                                       metadata thys $@
